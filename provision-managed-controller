pipeline {
  agent {label 'default-jnlp'}  
  stages {
    stage('Provision Managed Controller') {
      steps {
        checkout scm
        echo "GitHub username: ${GitHubUsername}"
        echo "GitHub Org Name: ${GitHubOrganization}"
        echo "Jenkins userId: ${BUILD_USER_ID}"
        sh """
          curl -O http://cjoc/cjoc/jnlpJars/jenkins-cli.jar
          sed -i "s/REPLACE_GITHUB_USERNAME/$GitHubUsername/g" ./groovy/oc-create-update-managed-controller.groovy
          sed -i "s/REPLACE_GITHUB_ORG/$GitHubOrganization/g" ./groovy/oc-create-update-managed-controller.groovy
          sed -i "s/REPLACE_JENKINS_USER/$BUILD_USER_ID/g" ./groovy/oc-create-update-managed-controller.groovy
          sed -i "s/REPLACE_USER_EMAIL/$BUILD_USER_EMAIL/g" ./groovy/oc-create-update-managed-controller.groovy
        """
        withCredentials([usernamePassword(credentialsId: 'admin-cli-token', usernameVariable: 'JENKINS_CLI_USR', passwordVariable: 'JENKINS_CLI_PSW')]) {
          sh """
            alias cli='java -jar jenkins-cli.jar -s http://cjoc/cjoc/ -auth $JENKINS_CLI_USR:$JENKINS_CLI_PSW'
            cli groovy =<./groovy/oc-create-update-managed-controller.groovy
          """
        }
        
        echo "begin config bundle updates"
        sh "sed -i \"s/REPLACE_GITHUB_ORG/$GitHubOrganization/g\" ./groovy/ops-create-github-app-credential.groovy"
        withCredentials([usernamePassword(credentialsId: 'admin-cli-token', usernameVariable: 'JENKINS_CLI_USR', passwordVariable: 'JENKINS_CLI_PSW')]) {
            sh """
                alias cli='java -jar jenkins-cli.jar -s http://teams-ops/teams-ops/ -auth $JENKINS_CLI_USR:$JENKINS_CLI_PSW'
                cli groovy =<./groovy/ops-create-github-app-credential.groovy
            """
        }
        withCredentials([usernamePassword(credentialsId: "${GitHubOrganization}",
                                          usernameVariable: 'GITHUB_APP',
                                          passwordVariable: 'GITHUB_ACCESS_TOKEN')]) {
          sh(script: """
            INSTALLATION_ID=\$( curl -s -H "Authorization: Bearer ${GITHUB_ACCESS_TOKEN}" -H "Accept: application/vnd.github.antiope-preview+json" -H "Accept: application/vnd.github.machine-man-preview+json" https://api.github.com/app/installations | jq .[0].id )
            echo "\$INSTALLATION_ID"
            INSTALLATION_TOKEN=\$( curl -s -H "Authorization: Bearer ${GITHUB_ACCESS_TOKEN}" -H "Accept: application/vnd.github.antiope-preview+json" -H "Accept: application/vnd.github.machine-man-preview+json" -d '{"permissions":{ "checks":"write"}}' https://api.github.com/app/installations/\$INSTALLATION_ID/access_tokens | jq .token | tr -d '"' )
            echo "\$INSTALLATION_TOKEN"
            rm -rf ./cloudbees-ci-config-bundle || true
            mkdir -p cloudbees-ci-config-bundle
            cd cloudbees-ci-config-bundle
            git init
            git config user.email "${BUILD_USER_EMAIL}"
            git config user.name "${GitHubUsername}"
            git remote add origin https://x-access-token:\$INSTALLATION_TOKEN@github.com/${GitHubOrganization}/cloudbees-ci-config-bundle.git
            git pull origin master
            sed -i "s/REPLACE_GITHUB_USERNAME/$GitHubUsername/g" bundle.yaml
            sed -i "s/REPLACE_GITHUB_USERNAME/$GitHubUsername/g" jenkins.yaml
            sed -i "s/REPLACE_GITHUB_ORG/$GitHubOrganization/g" jenkins.yaml
            sed -i "s/REPLACE_JENKINS_USER/$BUILD_USER_ID/g" jenkins.yaml
            sed -i "s/REPLACE_USER_EMAIL/$BUILD_USER_EMAIL/g" jenkins.yaml
            git add *
            git commit -a -m 'updating ${GitHubOrganization}/cloudbees-ci-config bundle for ${GitHubUsername}'
            git push -u origin master
          """)
        }
        sh "sed -i \"s/REPLACE_GITHUB_ORG/$GitHubOrganization/g\" ./groovy/ops-delete-github-app-credential.groovy" 
        withCredentials([usernamePassword(credentialsId: 'admin-cli-token', usernameVariable: 'JENKINS_CLI_USR', passwordVariable: 'JENKINS_CLI_PSW')]) {
            sh """
                alias cli='java -jar jenkins-cli.jar -s http://teams-ops/teams-ops/ -auth $JENKINS_CLI_USR:$JENKINS_CLI_PSW'
                cli groovy =<./groovy/ops-delete-github-app-credential.groovy
            """
        }
      }
    }
  }
}
